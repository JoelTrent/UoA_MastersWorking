---
title: "Experiment plots"
output: html_document
date: "2023-09-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(dev = "png",
                      dpi = 300,
                      cache = FALSE,
                      fig.dim = c(7, 4),
                      fig.align = "centre")

library(here)
library(tidyverse)
library(data.table)
library(ggplot2)
```


```{r}
data_df <- read_csv(file=here("Outputs", "logistic", "confidence_interval_ll_calls_algos.csv"))
algo_df <- read_csv(file=here("Outputs", "logistic", "algos.csv"))

data_df_means <- data_df %>% 
  arrange(algo_key, parameter) %>%
  group_by(parameter) %>%
  mutate(opt_rank =rank(optimisation_calls, ties.method ='min'), like_rank =rank(likelihood_calls, ties.method ='min')) %>%
  group_by(algo_key) %>%
  mutate(mean_opt_rank=mean(opt_rank), mean_like_rank=mean(like_rank), mean_opt_calls=mean(optimisation_calls), mean_ll_calls=mean(likelihood_calls)) %>%
  arrange(desc(-mean_like_rank)) %>%
  ungroup()


data_df %>% left_join(algo_df) %>% 
  select(-algo_key) %>%
  arrange(parameter, likelihood_calls, optimisation_calls) %>%
  group_by(parameter) %>%
  mutate(opt_rank =rank(optimisation_calls, ties.method ='min'), like_rank =rank(likelihood_calls, ties.method ='min')) %>%
  ungroup() %>%
  select(parameter, algo_name, likelihood_calls, like_rank, optimisation_calls, opt_rank) %>%
  write_csv(file=here("Outputs", "logistic", "algos_parameters.csv"))
  

data_df_means %>% left_join(algo_df) %>% 
  select(algo_name, mean_like_rank, mean_ll_calls, mean_opt_rank, mean_opt_calls) %>%
  unique() %>%
  mutate_if(is.numeric, signif, digits=3) %>%
  write_csv(file=here("Outputs", "logistic", "algos_mean.csv"))
```

```{r}
data_df <- read_csv(file=here("Outputs", "STAT5", "confidence_interval_ll_calls_algos.csv"))

data_df_means <- data_df %>% 
  arrange(algo_key, parameter) %>%
  group_by(parameter) %>%
  mutate(opt_rank =rank(optimisation_calls, ties.method ='min'), like_rank =rank(likelihood_calls, ties.method ='min')) %>%
  group_by(algo_key) %>%
  mutate(mean_opt_rank=mean(opt_rank), mean_like_rank=mean(like_rank), mean_opt_calls=mean(optimisation_calls), mean_ll_calls=mean(likelihood_calls)) %>%
  arrange(desc(-mean_like_rank)) %>%
  ungroup()


data_df %>% left_join(algo_df) %>% 
  select(-algo_key) %>%
  arrange(parameter, likelihood_calls, optimisation_calls) %>%
  group_by(parameter) %>%
  mutate(opt_rank =rank(optimisation_calls, ties.method ='min'), like_rank =rank(likelihood_calls, ties.method ='min')) %>%
  ungroup() %>%
  select(parameter, algo_name, likelihood_calls, like_rank, optimisation_calls, opt_rank) %>%
  write_csv(file=here("Outputs", "STAT5", "algos_parameters.csv"))
  

data_df_means %>% left_join(algo_df) %>% 
  select(algo_name, mean_like_rank, mean_ll_calls, mean_opt_rank, mean_opt_calls) %>%
  unique() %>%
  mutate_if(is.numeric, signif, digits=3) %>%
  write_csv(file=here("Outputs", "STAT5", "algos_mean.csv"))
```

Increasing find_zero_atol strictly decreases the number of LL evaluations because it strictly decreases the number of optimisation calls. This occurs after around 1e-14.
Increasing opt_abstol decreases the number of LL evaluations in general. However, if it gets too high then the optimiser will not find the true profile ll at each location and resultantly the number of optimisation calls may increase, either increasing the number of LL evaluations or making the magnitude of the decrease smaller.

```{r}
data_df <- read_csv(file=here("Outputs", "logistic", "confidence_interval_ll_calls.csv"))
data_df$parameter = as.factor(data_df$parameter)

data_df %>% filter(find_zero_atol==0.0) %>% 
  ggplot(aes(x=opt_abstol, y=likelihood_calls)) + 
  geom_point(aes(colour=parameter)) +
  scale_x_continuous(trans="log10") +
  theme_classic()+   
  theme(panel.grid.minor.y = element_line(size=0.1, color="grey"),     
        panel.grid.minor.x = element_line(size=0.1, color="grey"))


data_df %>% filter(find_zero_atol==0.0) %>% 
  ggplot(aes(x=opt_abstol, y=optimisation_calls)) + 
  geom_point(aes(colour=parameter)) +
  scale_x_continuous(trans="log10") +
  theme_classic()+   
  theme(panel.grid.minor.y = element_line(size=0.1, color="grey"),     
        panel.grid.minor.x = element_line(size=0.1, color="grey"))

data_df %>% filter(opt_abstol==0.0) %>% 
  ggplot(aes(x=find_zero_atol, y=likelihood_calls)) + 
  geom_point(aes(colour=parameter)) +
  scale_x_continuous(trans="log10") +
  theme_classic()+   
  theme(panel.grid.minor.y = element_line(size=0.1, color="grey"),     
        panel.grid.minor.x = element_line(size=0.1, color="grey"))

data_df %>% filter(opt_abstol==0.0) %>% 
  ggplot(aes(x=find_zero_atol, y=optimisation_calls)) + 
  geom_point(aes(colour=parameter)) +
  scale_x_continuous(trans="log10") +
  theme_classic()+   
  theme(panel.grid.minor.y = element_line(size=0.1, color="grey"),     
        panel.grid.minor.x = element_line(size=0.1, color="grey"))

data_df$find_zero_atol = as.factor(data_df$find_zero_atol)

data_df %>%
  ggplot(aes(x=opt_abstol, y=likelihood_calls)) + 
  geom_line(aes(colour=find_zero_atol)) +
  facet_wrap(~parameter,ncol=1, scales = "free_y")+
  scale_x_continuous(trans="log10") +
  theme_classic()+   
  theme(panel.grid.minor.y = element_line(size=0.1, color="grey"),     
        panel.grid.minor.x = element_line(size=0.1, color="grey"))

```   
